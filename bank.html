<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>资产合约管理</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:24px;color:#111}
.row{display:flex;gap:12px;align-items:center;margin:8px 0}
input,select,textarea,button{font-size:14px;padding:8px;border:1px solid #ddd;border-radius:8px}
button{background:#111;color:#fff;border:none;cursor:pointer}
button:disabled{background:#aaa;cursor:not-allowed}
.card{border:1px solid #eee;border-radius:12px;padding:16px;margin:12px 0}
.ok{color:#2e7d32}
.bad{color:#c62828}
</style>
</head>
<body>
<h2>资产合约管理</h2>
<div class="card">
  <div class="row">
    <select id="providerSelect"></select>
    <button id="connectBtn">连接钱包</button>
    <span id="account"></span>
  </div>
  <div class="row">
    <span>当前链:</span>
    <span id="chainInfo"></span>
    <span style="margin-left:12px">我的原生余额:</span>
    <span id="nativeBalance"></span>
  </div>
</div>

<div class="card">
  <h3>部署资产合约</h3>
  <div class="row">
    <input id="newName" placeholder="代币名称 (如 BankToken)" style="width:240px">
    <input id="newSymbol" placeholder="符号 (如 BKT)" style="width:160px">
    <input id="newRate" placeholder="每 1 原生币增发多少代币" style="width:260px">
  </div>
  <div class="row">
    <textarea id="bankAbiInput" placeholder="ABI JSON (含 constructor)" style="width:100%;height:120px"></textarea>
  </div>
  <div class="row">
    <textarea id="bankBytecodeInput" placeholder="0x 开头的字节码" style="width:100%;height:120px"></textarea>
  </div>
  <div class="row">
    <button id="deployBankBtn">部署资产合约</button>
    <a href="https://remix.ethereum.org/?#code=%2F%2F%20Paste%20MintBankToken.sol%20here" target="_blank" style="margin-left:12px">打开 Remix</a>
  </div>
  <div id="deployBankInfo"></div>
</div>

<div class="card">
  <div class="row">
    <input id="bankAddr" placeholder="资产合约地址" style="width:420px">
    <button id="bankLoadBtn">加载</button>
    <span id="bankOwner"></span>
    <span id="bankMintRate"></span>
  </div>
  <div class="row">
    <span>合约原生余额:</span>
    <span id="bankNative"></span>
    <span style="margin-left:12px">我的代币余额:</span>
    <span id="myTokenBalance"></span>
  </div>
  <div class="row">
    <input id="ratePerNative" placeholder="每 1 原生币增发多少代币" style="width:320px">
    <button id="setRateBtn">更新增发比率</button>
  </div>
  <div class="row">
    <input id="depositAmount" placeholder="存入原生币数量 (例如 0.1)" style="width:280px">
    <button id="depositBtn">存入并增发</button>
  </div>
  <div class="row">
    <button id="withdrawNativeBtn">提取合约内所有原生资产</button>
  </div>
  <div class="row">
    <input id="erc20ToWithdraw" placeholder="要提取的ERC20合约地址" style="width:360px">
    <button id="withdrawTokenAllBtn">提取该ERC20全部资产</button>
  </div>
  <div id="bankTxInfo"></div>
  <div id="bankInfo"></div>
</div>

<script type="module">
import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.min.js'

const chainNames = { 1:'Ethereum',5:'Goerli',56:'BNB Smart Chain',66:'OKTC',137:'Polygon',10:'Optimism',42161:'Arbitrum One',43114:'Avalanche',59144:'Linea',8453:'Base' }
const nativeSymbols = { 1:'ETH',5:'ETH',56:'BNB',66:'OKT',137:'MATIC',10:'ETH',42161:'ETH',43114:'AVAX',59144:'ETH',8453:'ETH' }
const mintBankAbi = [
  {"type":"function","name":"name","stateMutability":"view","inputs":[],"outputs":[{"type":"string"}]},
  {"type":"function","name":"symbol","stateMutability":"view","inputs":[],"outputs":[{"type":"string"}]},
  {"type":"function","name":"decimals","stateMutability":"view","inputs":[],"outputs":[{"type":"uint8"}]},
  {"type":"function","name":"owner","stateMutability":"view","inputs":[],"outputs":[{"type":"address"}]},
  {"type":"function","name":"mintRate","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
  {"type":"function","name":"balanceOf","stateMutability":"view","inputs":[{"name":"owner","type":"address"}],"outputs":[{"type":"uint256"}]},
  {"type":"function","name":"deposit","stateMutability":"payable","inputs":[],"outputs":[]},
  {"type":"function","name":"withdrawNativeAll","stateMutability":"nonpayable","inputs":[],"outputs":[]},
  {"type":"function","name":"withdrawTokenAll","stateMutability":"nonpayable","inputs":[{"name":"token","type":"address"}],"outputs":[]},
  {"type":"function","name":"setMintRate","stateMutability":"nonpayable","inputs":[{"name":"_rate","type":"uint256"}],"outputs":[]}
]

const bankDefaultAbi = JSON.stringify([
  {"type":"constructor","inputs":[{"name":"_name","type":"string"},{"name":"_symbol","type":"string"},{"name":"_mintRate","type":"uint256"}]},
  {"type":"function","name":"name","stateMutability":"view","inputs":[],"outputs":[{"type":"string"}]},
  {"type":"function","name":"symbol","stateMutability":"view","inputs":[],"outputs":[{"type":"string"}]},
  {"type":"function","name":"decimals","stateMutability":"view","inputs":[],"outputs":[{"type":"uint8"}]},
  {"type":"function","name":"owner","stateMutability":"view","inputs":[],"outputs":[{"type":"address"}]},
  {"type":"function","name":"mintRate","stateMutability":"view","inputs":[],"outputs":[{"type":"uint256"}]},
  {"type":"function","name":"balanceOf","stateMutability":"view","inputs":[{"name":"owner","type":"address"}],"outputs":[{"type":"uint256"}]},
  {"type":"function","name":"deposit","stateMutability":"payable","inputs":[],"outputs":[]},
  {"type":"function","name":"withdrawNativeAll","stateMutability":"nonpayable","inputs":[],"outputs":[]},
  {"type":"function","name":"withdrawTokenAll","stateMutability":"nonpayable","inputs":[{"name":"token","type":"address"}],"outputs":[]},
  {"type":"function","name":"setMintRate","stateMutability":"nonpayable","inputs":[{"name":"_rate","type":"uint256"}],"outputs":[]}
])

let provider
let browserProvider
let signer
let account
let chainId
let providersList = []
let bank
let bankDecimals = 18

function pickProviders(){
  const list = []
  const eth = window.ethereum
  const candidates = Array.isArray(eth?.providers) ? eth.providers : (eth ? [eth] : [])
  for(const p of candidates){
    const name = p.isMetaMask ? 'MetaMask' : (p.isOkxWallet ? 'OKX' : (p.isBinance ? 'Binance' : 'Wallet'))
    list.push({name, provider:p})
  }
  const sel = document.getElementById('providerSelect')
  sel.innerHTML = ''
  for(let i=0;i<list.length;i++){
    const opt = document.createElement('option')
    opt.value = String(i)
    opt.textContent = list[i].name
    sel.appendChild(opt)
  }
  if(list.length===0){
    const opt = document.createElement('option')
    opt.value = '0'
    opt.textContent = '未检测到钱包'
    sel.appendChild(opt)
  }
  providersList = list.map(x=>x.provider)
}

function getSelectedProvider(){
  const sel = document.getElementById('providerSelect')
  const idx = Number(sel.value||0)
  return providersList[idx] || window.ethereum || null
}

async function connect(){
  provider = getSelectedProvider()
  if(!provider) return
  browserProvider = new ethers.BrowserProvider(provider)
  signer = await browserProvider.getSigner()
  account = await signer.getAddress()
  const cidHex = await provider.request({method:'eth_chainId'})
  chainId = Number(cidHex)
  document.getElementById('account').textContent = account
  const name = chainNames[chainId] || '未知链'
  document.getElementById('chainInfo').textContent = `${chainId} (${name})`
  await updateNativeBalance()
}

async function updateNativeBalance(){
  if(!browserProvider || !account) return
  try{
    const bal = await browserProvider.getBalance(account)
    const sym = nativeSymbols[chainId] || 'ETH'
    document.getElementById('nativeBalance').textContent = `${ethers.formatUnits(bal, 18)} ${sym}`
  }catch(e){
    document.getElementById('nativeBalance').textContent = ''
  }
}

async function loadBank(){
  const addr = document.getElementById('bankAddr').value.trim()
  if(!ethers.isAddress(addr)) { document.getElementById('bankInfo').textContent = '无效合约地址'; return }
  bank = new ethers.Contract(addr, mintBankAbi, signer)
  try{
    const [own, rate, dec, sym, nm] = await Promise.all([
      bank.owner(), bank.mintRate(), bank.decimals(), bank.symbol(), bank.name()
    ])
    bankDecimals = Number(dec)
    document.getElementById('bankOwner').textContent = `创建者: ${own}`
    document.getElementById('bankMintRate').textContent = `增发比率: ${rate.toString()}（每 1 原生币对应 parseUnits 的代币数量）`
    await refreshBankBalances()
    document.getElementById('bankInfo').textContent = `代币: ${nm} (${sym}) / ${bankDecimals}`
  }catch(e){
    document.getElementById('bankInfo').textContent = '加载失败: '+(e?.message||String(e))
  }
}

async function refreshBankBalances(){
  if(!bank) return
  try{
    const addr = await bank.getAddress()
    const nativeBal = await browserProvider.getBalance(addr)
    document.getElementById('bankNative').textContent = ethers.formatUnits(nativeBal, 18)
    const myBal = await bank.balanceOf(account)
    document.getElementById('myTokenBalance').textContent = ethers.formatUnits(myBal, bankDecimals)
  }catch(e){
    document.getElementById('bankNative').textContent = ''
    document.getElementById('myTokenBalance').textContent = ''
  }
}

async function depositToBank(){
  if(!bank) { document.getElementById('bankTxInfo').textContent = '请先加载合约'; return }
  try{
    const amtStr = document.getElementById('depositAmount').value.trim()
    const val = ethers.parseUnits(amtStr||'0', 18)
    const tx = await bank.deposit({ value: val })
    document.getElementById('bankTxInfo').textContent = '存入中: '+tx.hash
    await tx.wait()
    document.getElementById('bankTxInfo').textContent = '完成'
    await refreshBankBalances()
  }catch(e){
    document.getElementById('bankTxInfo').textContent = '失败: '+(e?.message||String(e))
  }
}

async function withdrawNativeAll(){
  if(!bank) { document.getElementById('bankTxInfo').textContent = '请先加载合约'; return }
  try{
    const tx = await bank.withdrawNativeAll()
    document.getElementById('bankTxInfo').textContent = '提取中: '+tx.hash
    await tx.wait()
    document.getElementById('bankTxInfo').textContent = '完成'
    await refreshBankBalances()
  }catch(e){ document.getElementById('bankTxInfo').textContent = '失败: '+(e?.message||String(e)) }
}

async function withdrawTokenAll(){
  if(!bank) { document.getElementById('bankTxInfo').textContent = '请先加载合约'; return }
  const tokenAddr = document.getElementById('erc20ToWithdraw').value.trim()
  if(!ethers.isAddress(tokenAddr)) { document.getElementById('bankTxInfo').textContent = '无效ERC20地址'; return }
  try{
    const tx = await bank.withdrawTokenAll(tokenAddr)
    document.getElementById('bankTxInfo').textContent = '提取中: '+tx.hash
    await tx.wait()
    document.getElementById('bankTxInfo').textContent = '完成'
    await refreshBankBalances()
  }catch(e){ document.getElementById('bankTxInfo').textContent = '失败: '+(e?.message||String(e)) }
}

async function deployBank(){
  if(!signer) { document.getElementById('deployBankInfo').textContent = '请先连接钱包'; return }
  try{
    const name = (document.getElementById('newName').value||'').trim() || 'BankToken'
    const symbol = (document.getElementById('newSymbol').value||'').trim() || 'BKT'
    const rateStr = (document.getElementById('newRate').value||'').trim() || '1'
    let abiText = (document.getElementById('bankAbiInput').value||'').trim()
    let bytecode = (document.getElementById('bankBytecodeInput').value||'').trim()
    if(!abiText) abiText = bankDefaultAbi
    if(!bytecode || !bytecode.startsWith('0x')){ document.getElementById('deployBankInfo').textContent = '请粘贴 0x 开头的字节码'; return }
    const abi = JSON.parse(abiText)
    const mintRate = ethers.parseUnits(rateStr, 18)
    const hasCtor = Array.isArray(abi) && abi.some(x=>x.type==='constructor')
    let factory
    let contract
    if(hasCtor){
      factory = new ethers.ContractFactory(abi, bytecode, signer)
      contract = await factory.deploy(name, symbol, mintRate)
    } else {
      const coder = ethers.AbiCoder.defaultAbiCoder()
      const encoded = coder.encode(['string','string','uint256'], [name, symbol, mintRate])
      const appended = bytecode + encoded.slice(2)
      factory = new ethers.ContractFactory(abi, appended, signer)
      contract = await factory.deploy()
    }
    const tx = contract.deploymentTransaction()
    document.getElementById('deployBankInfo').textContent = '部署中: '+(tx?.hash||'')
    await contract.waitForDeployment()
    const addr = await contract.getAddress()
    document.getElementById('deployBankInfo').textContent = `部署成功: ${addr}`
    document.getElementById('bankAddr').value = addr
    await loadBank()
  }catch(e){
    document.getElementById('deployBankInfo').textContent = '部署失败: '+(e?.message||String(e))
  }
}

async function loadLocalArtifacts(){
  try{
    const abiResp = await fetch('./bank.abi')
    const byteResp = await fetch('./bank.bytecode')
    if(abiResp.ok){
      const txt = await abiResp.text()
      document.getElementById('bankAbiInput').value = txt
    }
    if(byteResp.ok){
      const txt = await byteResp.text()
      document.getElementById('bankBytecodeInput').value = txt
    }
  }catch(e){
    // ignore
  }
}

async function setRate(){
  if(!bank) { document.getElementById('bankTxInfo').textContent = '请先加载合约'; return }
  try{
    const v = document.getElementById('ratePerNative').value.trim()
    const parsed = ethers.parseUnits(v||'0', bankDecimals)
    const tx = await bank.setMintRate(parsed)
    document.getElementById('bankTxInfo').textContent = '更新中: '+tx.hash
    await tx.wait()
    document.getElementById('bankTxInfo').textContent = '已更新'
    await loadBank()
  }catch(e){ document.getElementById('bankTxInfo').textContent = '失败: '+(e?.message||String(e)) }
}

document.getElementById('connectBtn').addEventListener('click', connect)
document.getElementById('providerSelect').addEventListener('change', ()=>{})
document.getElementById('bankLoadBtn').addEventListener('click', loadBank)
document.getElementById('depositBtn').addEventListener('click', depositToBank)
document.getElementById('withdrawNativeBtn').addEventListener('click', withdrawNativeAll)
document.getElementById('withdrawTokenAllBtn').addEventListener('click', withdrawTokenAll)
document.getElementById('deployBankBtn').addEventListener('click', deployBank)
document.getElementById('setRateBtn').addEventListener('click', setRate)

pickProviders()
loadLocalArtifacts()
</script>
</body>
</html>