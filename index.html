<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>群发吧</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
 
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:24px;color:#111}
.row{display:flex;gap:12px;align-items:center;margin:8px 0}
input,select,textarea,button{font-size:14px;padding:8px;border:1px solid #ddd;border-radius:8px}
button{background:#111;color:#fff;border:none;cursor:pointer}
button:disabled{background:#aaa;cursor:not-allowed}
textarea{width:100%;height:200px}
.card{border:1px solid #eee;border-radius:12px;padding:16px;margin:12px 0}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.ok{color:#2e7d32}
.bad{color:#c62828}
</style>
</head>
<body>
<h2>代币群发吧</h2>
<div class="card">
  <div class="row">
    <select id="providerSelect"></select>
    <button id="connectBtn">连接钱包</button>
    <span id="account"></span>
  </div>
  <div class="row">
    <span>当前链:</span>
    <span id="chainInfo"></span>
    <span id="supportInfo"></span>
    <button id="deployBtn" style="display:none">部署群发合约</button>
    <span id="deployInfo"></span>
    <span style="margin-left:12px">原生余额:</span>
    <span id="nativeBalance"></span>
  </div>
</div>

<div class="card">
  <div class="row">
    <label><input type="radio" name="mode" value="ETH" checked> ETH</label>
    <label><input type="radio" name="mode" value="ERC20"> ERC20</label>
    <input id="tokenAddress" placeholder="ERC20 合约地址" style="width:360px">
    <span id="tokenMeta"></span>
    <span id="tokenBalance" style="margin-left:12px"></span>
  </div>
  <div class="row">
    <span>每行: 地址 与 数量，分隔支持 , 或 ---- 或 空格</span>
  </div>
<textarea id="lines" placeholder="0x... , 1.23
0x... ---- 0.5
0x...    100"></textarea>
  <div class="grid">
    <div>
      <button id="parseBtn">解析</button>
      <div id="parseInfo"></div>
    </div>
    <div>
      <button id="sendBtn" disabled>发送</button>
      <div id="txInfo"></div>
    </div>
  </div>
</div>

<div class="card" id="deployPanel" style="display:none">
  <div class="row">
    <span>管理员快速部署（需 ABI 与 Bytecode）：</span>
    <a href="https://remix.ethereum.org/?#code=%2F%2F%20Paste%20Disperse.sol%20here" target="_blank">打开 Remix</a>
  </div>
  <div class="row">
    <textarea id="abiInput" placeholder="ABI JSON"></textarea>
  </div>
  <div class="row">
    <textarea id="bytecodeInput" placeholder="0x 开头的字节码"></textarea>
  </div>
  <div class="row">
    <button id="deployWithArtifactBtn">使用 ABI/Bytecode 部署</button>
  </div>
</div>

<script type="module">
import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.min.js'
const cfg = {
  contracts: {
    1: '',
    56: '',
    66: '',
    8453: '0x92edBa94BF4092341Bf2543E6BafA6bb58831233',
  }
}
const chainNames = {
  1: 'Ethereum',
  5: 'Goerli',
  56: 'BNB Smart Chain',
  66: 'OKTC',
  137: 'Polygon',
  10: 'Optimism',
  42161: 'Arbitrum One',
  43114: 'Avalanche',
  59144: 'Linea',
  8453: 'Base'
}
const chainBatchLimits = { 1: 1000, 5: 500, 56: 800, 66: 500, 137: 600, 10: 300, 42161: 400, 43114: 400, 59144: 300, 8453: 200 }
const adminAddr = '0x927C4306a908362694eEce7E4f45C1624DD51721'.toLowerCase()
const defaultAbi = JSON.stringify([
  {"type":"function","name":"disperseEther","stateMutability":"payable","inputs":[{"name":"recipients","type":"address[]"},{"name":"values","type":"uint256[]"}],"outputs":[]},
  {"type":"function","name":"disperseTokenSimple","stateMutability":"nonpayable","inputs":[{"name":"token","type":"address"},{"name":"recipients","type":"address[]"},{"name":"values","type":"uint256[]"}],"outputs":[]},
  {"type":"event","name":"DisperseEther","inputs":[{"name":"sender","type":"address","indexed":true},{"name":"count","type":"uint256","indexed":false},{"name":"total","type":"uint256","indexed":false}]},
  {"type":"event","name":"DisperseToken","inputs":[{"name":"sender","type":"address","indexed":true},{"name":"token","type":"address","indexed":true},{"name":"count","type":"uint256","indexed":false},{"name":"total","type":"uint256","indexed":false}]}
])
const defaultBytecode = '0x6080604052348015600e575f5ffd5b50610bf28061001c5f395ff3fe60806040526004361061002c575f3560e01c806351ba162c14610037578063e63d38ed1461005f57610033565b3661003357005b5f5ffd5b348015610042575f5ffd5b5061005d6004803603810190610058919061068f565b61007b565b005b61007960048036038101906100749190610720565b61027a565b005b8181905084849050146100c3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100ba906107f8565b60405180910390fd5b5f5f90505f5f90505b83839050811015610207578383828181106100ea576100e9610816565b5b90506020020135826100fc9190610879565b91508673ffffffffffffffffffffffffffffffffffffffff166323b872dd3388888581811061012e5761012d610816565b5b905060200201602081019061014391906108d6565b87878681811061015657610155610816565b5b905060200201356040518463ffffffff1660e01b815260040161017b9392919061091f565b6020604051808303815f875af1158015610197573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906101bb9190610989565b6101fa576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101f1906109fe565b60405180910390fd5b80806001019150506100cc565b508573ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f663b9a87e943181adb45f043aca546ec975f5d95afc70e73a4008e8e7b0ed7e4878790508460405161026a929190610a1c565b60405180910390a3505050505050565b8181905084849050146102c2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102b9906107f8565b60405180910390fd5b5f5f90505f5f90505b8383905081101561030a578383828181106102e9576102e8610816565b5b90506020020135826102fb9190610879565b915080806001019150506102cb565b508034101561034e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161034590610a8d565b60405180910390fd5b5f5f90505b85859050811015610454575f86868381811061037257610371610816565b5b905060200201602081019061038791906108d6565b73ffffffffffffffffffffffffffffffffffffffff168585848181106103b0576103af610816565b5b905060200201356040516103c390610ad8565b5f6040518083038185875af1925050503d805f81146103fd576040519150601f19603f3d011682016040523d82523d5f602084013e610402565b606091505b5050905080610446576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161043d90610b36565b60405180910390fd5b508080600101915050610353565b505f4790505f81111561050b575f3373ffffffffffffffffffffffffffffffffffffffff168260405161048690610ad8565b5f6040518083038185875af1925050503d805f81146104c0576040519150601f19603f3d011682016040523d82523d5f602084013e6104c5565b606091505b5050905080610509576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161050090610b9e565b60405180910390fd5b505b3373ffffffffffffffffffffffffffffffffffffffff167f1255f7d7511a20f43f60dafdfff71fd40ec5608267bb7ea0e99ff31f715b95428787905084604051610556929190610a1c565b60405180910390a2505050505050565b5f5ffd5b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6105978261056e565b9050919050565b5f6105a88261058d565b9050919050565b6105b88161059e565b81146105c2575f5ffd5b50565b5f813590506105d3816105af565b92915050565b5f5ffd5b5f5ffd5b5f5ffd5b5f5f83601f8401126105fa576105f96105d9565b5b8235905067ffffffffffffffff811115610617576106166105dd565b5b602083019150836020820283011115610633576106326105e1565b5b9250929050565b5f5f83601f84011261064f5761064e6105d9565b5b8235905067ffffffffffffffff81111561066c5761066b6105dd565b5b602083019150836020820283011115610688576106876105e1565b5b9250929050565b5f5f5f5f5f606086880312156106a8576106a7610566565b5b5f6106b5888289016105c5565b955050602086013567ffffffffffffffff8111156106d6576106d561056a565b5b6106e2888289016105e5565b9450945050604086013567ffffffffffffffff8111156107055761070461056a565b5b6107118882890161063a565b92509250509295509295909350565b5f5f5f5f6040858703121561073857610737610566565b5b5f85013567ffffffffffffffff8111156107555761075461056a565b5b610761878288016105e5565b9450945050602085013567ffffffffffffffff8111156107845761078361056a565b5b6107908782880161063a565b925092505092959194509250565b5f82825260208201905092915050565b7f4c454e00000000000000000000000000000000000000000000000000000000005f82015250565b5f6107e260038361079e565b91506107ed826107ae565b602082019050919050565b5f6020820190508181035f83015261080f816107d6565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f819050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61088382610843565b915061088e83610843565b92508282019050808211156108a6576108a561084c565b5b92915050565b6108b58161058d565b81146108bf575f5ffd5b50565b5f813590506108d0816108ac565b92915050565b5f602082840312156108eb576108ea610566565b5b5f6108f8848285016108c2565b91505092915050565b61090a8161058d565b82525050565b61091981610843565b82525050565b5f6060820190506109325f830186610901565b61093f6020830185610901565b61094c6040830184610910565b949350505050565b5f8115159050919050565b61096881610954565b8114610972575f5ffd5b50565b5f815190506109838161095f565b92915050565b5f6020828403121561099e5761099d610566565b5b5f6109ab84828501610975565b91505092915050565b7f54465300000000000000000000000000000000000000000000000000000000005f82015250565b5f6109e860038361079e565b91506109f3826109b4565b602082019050919050565b5f6020820190508181035f830152610a15816109dc565b9050919050565b5f604082019050610a2f5f830185610910565b610a3c6020830184610910565b9392505050565b7f46554e44530000000000000000000000000000000000000000000000000000005f82015250565b5f610a7760058361079e565b9150610a8282610a43565b602082019050919050565b5f6020820190508181035f830152610aa481610a6b565b9050919050565b5f81905092915050565b50565b5f610ac35f83610aab565b9150610ace82610ab5565b5f82019050919050565b5f610ae282610ab8565b9150819050919050565b7f45544800000000000000000000000000000000000000000000000000000000005f82015250565b5f610b2060038361079e565b9150610b2b82610aec565b602082019050919050565b5f6020820190508181035f830152610b4d81610b14565b9050919050565b7f524546554e4400000000000000000000000000000000000000000000000000005f82015250565b5f610b8860068361079e565b9150610b9382610b54565b602082019050919050565b5f6020820190508181035f830152610bb581610b7c565b905091905056fea2646970667358221220a97f13beef47c9fb84317e4237f8e7346f2acebcb802cbec12a85bad3fada59964736f6c634300081e0033'
const nativeSymbols = { 1:'ETH',5:'ETH',56:'BNB',66:'OKT',137:'MATIC',10:'ETH',42161:'ETH',43114:'AVAX',59144:'ETH',8453:'ETH' }
const disperseAbi = [
  {"type":"function","name":"disperseEther","stateMutability":"payable","inputs":[{"name":"recipients","type":"address[]"},{"name":"values","type":"uint256[]"}],"outputs":[]},
  {"type":"function","name":"disperseTokenSimple","stateMutability":"nonpayable","inputs":[{"name":"token","type":"address"},{"name":"recipients","type":"address[]"},{"name":"values","type":"uint256[]"}],"outputs":[]}
]
const erc20Abi = [
  {"type":"function","name":"decimals","stateMutability":"view","inputs":[],"outputs":[{"type":"uint8"}]},
  {"type":"function","name":"symbol","stateMutability":"view","inputs":[],"outputs":[{"type":"string"}]},
  {"type":"function","name":"allowance","stateMutability":"view","inputs":[{"name":"owner","type":"address"},{"name":"spender","type":"address"}],"outputs":[{"type":"uint256"}]},
  {"type":"function","name":"approve","stateMutability":"nonpayable","inputs":[{"name":"spender","type":"address"},{"name":"value","type":"uint256"}],"outputs":[{"type":"bool"}]}
]

let provider
let browserProvider
let signer
let account
let chainId
let tokenDecimals = 18
let tokenSymbol = ''
let parsed = {recipients:[], values:[], total:0n}
let providersList = []

function pickProviders(){
  const list = []
  const eth = window.ethereum
  const candidates = Array.isArray(eth?.providers) ? eth.providers : (eth ? [eth] : [])
  for(const p of candidates){
    const name = p.isMetaMask ? 'MetaMask' : (p.isOkxWallet ? 'OKX' : (p.isBinance ? 'Binance' : 'Wallet'))
    list.push({name, provider:p})
  }
  const sel = document.getElementById('providerSelect')
  sel.innerHTML = ''
  for(let i=0;i<list.length;i++){
    const opt = document.createElement('option')
    opt.value = String(i)
    opt.textContent = list[i].name
    sel.appendChild(opt)
  }
  if(list.length===0){
    const opt = document.createElement('option')
    opt.value = '0'
    opt.textContent = '未检测到钱包'
    sel.appendChild(opt)
  }
  providersList = list.map(x=>x.provider)
}

function getSelectedProvider(){
  const sel = document.getElementById('providerSelect')
  const idx = Number(sel.value||0)
  return providersList[idx] || window.ethereum || null
}

async function connect(){
  provider = getSelectedProvider()
  if(!provider) return
  browserProvider = new ethers.BrowserProvider(provider)
  signer = await browserProvider.getSigner()
  account = await signer.getAddress()
  const cidHex = await provider.request({method:'eth_chainId'})
  chainId = Number(cidHex)
  document.getElementById('account').textContent = account
  const name = chainNames[chainId] || '未知链'
  document.getElementById('chainInfo').textContent = `${chainId} (${name})`
  refreshSupportUI()
  await updateNativeBalance()
}

async function ensureTokenMeta(){
  const mode = document.querySelector('input[name="mode"]:checked').value
  if(mode!=='ERC20') { tokenDecimals=18; tokenSymbol='ETH'; document.getElementById('tokenMeta').textContent = ''; document.getElementById('tokenBalance').textContent=''; return }
  const addr = document.getElementById('tokenAddress').value.trim()
  if(!ethers.isAddress(addr)) { document.getElementById('tokenMeta').textContent = '无效地址'; document.getElementById('tokenBalance').textContent=''; return }
  const c = new ethers.Contract(addr, erc20Abi, signer)
  try { tokenDecimals = Number(await c.decimals()); tokenSymbol = await c.symbol() } catch(e) { tokenDecimals=18; tokenSymbol='' }
  document.getElementById('tokenMeta').textContent = tokenSymbol? (tokenSymbol+' / '+tokenDecimals) : String(tokenDecimals)
  await updateTokenBalance(addr)
}

function parseValue(str, dec){
  return ethers.parseUnits(str, dec)
}

function parseLines(){
  parsed = {recipients:[], values:[], total:0n}
  const raw = document.getElementById('lines').value.split(/\n+/)
  const mode = document.querySelector('input[name="mode"]:checked').value
  for(const line of raw){
    if(!line.trim()) continue
    const parts = line.trim().split(/,|----|\s+/).filter(Boolean)
    if(parts.length<2) continue
    const addr = parts[0]
    const amtStr = parts[1]
    if(!ethers.isAddress(addr)) continue
    try{
      const val = parseValue(amtStr, mode==='ETH'? 18 : tokenDecimals)
      parsed.recipients.push(addr)
      parsed.values.push(val)
      parsed.total += val
    }catch(e){}
  }
  document.getElementById('parseInfo').textContent = '条目: '+parsed.recipients.length+' 总额: '+ethers.formatUnits(parsed.total, mode==='ETH'?18:tokenDecimals)+(mode==='ETH'?' ETH':' '+(tokenSymbol||'ERC20'))
  document.getElementById('sendBtn').disabled = !(parsed.recipients.length>0)
}

function chunk(arr, size){
  const out=[]
  for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i, i+size))
  return out
}
function sumValues(vals){
  let s=0n
  for(const v of vals) s += v
  return s
}

async function updateNativeBalance(){
  if(!browserProvider || !account) return
  try{
    const bal = await browserProvider.getBalance(account)
    const sym = nativeSymbols[chainId] || 'ETH'
    document.getElementById('nativeBalance').textContent = `${ethers.formatUnits(bal, 18)} ${sym}`
  }catch(e){
    document.getElementById('nativeBalance').textContent = ''
  }
}

async function updateTokenBalance(addr){
  if(!signer || !account || !ethers.isAddress(addr)) { document.getElementById('tokenBalance').textContent = '' ; return }
  try{
    const viewAbi = [
      {"type":"function","name":"balanceOf","stateMutability":"view","inputs":[{"name":"owner","type":"address"}],"outputs":[{"type":"uint256"}]}
    ]
    const c = new ethers.Contract(addr, viewAbi, browserProvider)
    const bal = await c.balanceOf(account)
    document.getElementById('tokenBalance').textContent = `${ethers.formatUnits(bal, tokenDecimals)} ${tokenSymbol||''}`
  }catch(e){
    document.getElementById('tokenBalance').textContent = ''
  }
}

function refreshSupportUI(){
  const addr = cfg.contracts[chainId]
  const supported = !!addr
  const s = document.getElementById('supportInfo')
  s.textContent = supported? '已支持' : '未支持'
  s.className = supported? 'ok' : 'bad'
  const canDeploy = !supported && account && account.toLowerCase() === adminAddr
  const btn = document.getElementById('deployBtn')
  btn.style.display = canDeploy? '' : 'none'
  document.getElementById('deployPanel').style.display = canDeploy? '' : 'none'
  if(canDeploy){
    const abiEl = document.getElementById('abiInput')
    if(abiEl && !abiEl.value.trim()) abiEl.value = defaultAbi
    const bcEl = document.getElementById('bytecodeInput')
    if(bcEl && !bcEl.value.trim()) bcEl.value = defaultBytecode
  }
}

async function deployDisperse(){
  try{
    let abiText = document.getElementById('abiInput').value.trim()
    let bytecode = document.getElementById('bytecodeInput').value.trim()
    if(!abiText) abiText = defaultAbi
    if(!bytecode) bytecode = defaultBytecode
    if(!bytecode.startsWith('0x')){
      document.getElementById('deployInfo').textContent = 'Bytecode 需以 0x 开头'
      return
    }
    const abi = JSON.parse(abiText)
    const factory = new ethers.ContractFactory(abi, bytecode, signer)
    const contract = await factory.deploy()
    const tx = contract.deploymentTransaction()
    document.getElementById('deployInfo').textContent = '部署中: '+(tx?.hash||'')
    await contract.waitForDeployment()
    const addr = await contract.getAddress()
    cfg.contracts[chainId] = addr
    document.getElementById('deployInfo').textContent = `部署成功: 链ID ${chainId} 合约 ${addr}`
    refreshSupportUI()
  }catch(e){
    document.getElementById('deployInfo').textContent = '部署失败: '+(e?.message||String(e))
  }
}

async function send(){
  if(!signer) return
  const addr = cfg.contracts[chainId]
  if(!addr){ document.getElementById('txInfo').textContent = '当前链未支持'; return }
  const c = new ethers.Contract(addr, disperseAbi, signer)
  const mode = document.querySelector('input[name="mode"]:checked').value
  const limit = chainBatchLimits[chainId] || 200
  const rChunks = chunk(parsed.recipients, limit)
  const vChunks = chunk(parsed.values, limit)
  if(mode==='ETH'){
    try{
      let lastHash=''
      for(let i=0;i<rChunks.length;i++){
        const valSum = sumValues(vChunks[i])
        const tx = await c.disperseEther(rChunks[i], vChunks[i], { value: valSum })
        document.getElementById('txInfo').textContent = `发送中(${i+1}/${rChunks.length}): ${tx.hash}`
        const receipt = await tx.wait()
        lastHash = receipt.transactionHash
      }
      document.getElementById('txInfo').textContent = '完成: '+lastHash
    }catch(e){ document.getElementById('txInfo').textContent = '失败: '+(e?.message||String(e)) }
  } else {
    const tokenAddr = document.getElementById('tokenAddress').value.trim()
    if(!ethers.isAddress(tokenAddr)) { document.getElementById('txInfo').textContent = '无效ERC20地址'; return }
    const token = new ethers.Contract(tokenAddr, erc20Abi, signer)
    try{
      const allowance = await token.allowance(account, addr)
      if(allowance < parsed.total){
        const txA = await token.approve(addr, parsed.total)
        document.getElementById('txInfo').textContent = '授权中: '+txA.hash
        await txA.wait()
      }
      let lastHash=''
      for(let i=0;i<rChunks.length;i++){
        const tx = await c.disperseTokenSimple(tokenAddr, rChunks[i], vChunks[i])
        document.getElementById('txInfo').textContent = `发送中(${i+1}/${rChunks.length}): ${tx.hash}`
        const receipt = await tx.wait()
        lastHash = receipt.transactionHash
      }
      document.getElementById('txInfo').textContent = '完成: '+lastHash
    }catch(e){ document.getElementById('txInfo').textContent = '失败: '+(e?.message||String(e)) }
  }
}

document.getElementById('connectBtn').addEventListener('click', connect)
document.getElementById('providerSelect').addEventListener('change', ()=>{ provider = getSelectedProvider() })
document.getElementById('parseBtn').addEventListener('click', ()=>{ parseLines() })
document.getElementById('sendBtn').addEventListener('click', send)
document.getElementById('tokenAddress').addEventListener('change', ensureTokenMeta)
document.querySelectorAll('input[name="mode"]').forEach(x=>x.addEventListener('change', ()=>{ ensureTokenMeta(); parseLines() }))
document.getElementById('deployBtn').addEventListener('click', deployDisperse)
document.getElementById('deployWithArtifactBtn').addEventListener('click', deployDisperse)

pickProviders()
</script>
</body>
</html>
